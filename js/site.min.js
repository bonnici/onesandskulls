function enableFileInput(){$("#file-input-button").removeClass("disabled")}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)"),t=a.exec(location.search);return null===t?"":decodeURIComponent(t[1])}function renderDataParam(){try{var e=LZString.decompressFromEncodedURIComponent(dataParam),a=JSONC.decompress(JSON.parse(e));renderReplayData(a,dataParam)}catch(t){$("#loading").hide(),$("#data-param-error").show(),console.error(t)}}function renderReplayData(e,a){var t="http://onesandskulls.com",r="/index.html",n=t+r+"?data="+a,c=encodeURIComponent(n),s="http://tinyurl.com/create.php?url="+c+"#success",o=stats.calculateStats(e.actions,e.playerDetails);updateGameDetails(e.gameDetails),updateActions(e.actions,e.gameDetails,e.playerDetails),$("#loading").hide(),$("#results-div").show(),$("#share-massive-url").attr("href",n),$("#share-tiny-url").attr("href",s),$("#share-alert").show(),drawCharts(o,e.gameDetails),document.getElementById("results-with-padding").scrollIntoView()}function raceIdToName(e){switch(e){case 1:return"Human";case 2:return"Dwarf";case 3:return"Skaven";case 4:return"Orc";case 5:return"Lizardman";case 7:return"Wood Elf";case 8:return"Chaos";case 9:return"Dark Elf";case 15:return"High Elf";case 24:return"Bretonnian";default:return e}}function rollTypeIdToName(e){switch(e){case-2:return"Kickoff Scatter";case-1:return"Kickoff";case 1:return"GFI";case 2:return"Dodge";case 3:return"Armour";case 4:return"Injury";case 5:return"Block";case 6:return"Stand Up";case 7:return"Pickup";case 8:return"Casualty";case 9:return"Catch";case 10:return"Scatter";case 11:return"Throw-in";case 12:return"Pass";case 16:return"Intercept";case 17:return"Wake-Up After KO";case 20:return"Bone-Head";case 21:return"Really Stupid";case 22:return"Wild Animal";case 23:return"Loner";case 24:return"Landing";case 26:return"Inaccurate Pass Scatter";case 29:return"Dauntless";case 27:return"Always Hungry";case 31:return"Jump Up";case 34:return"Stab";case 36:return"Leap";case 37:return"Foul Appearance";case 40:return"Take Root";case 42:return"Hail Mary Pass";case 46:return"Hypnotic Gaze";case 54:return"Fireball";case 55:return"Lightning Bolt";case 56:return"Throw Team-Mate";case 58:return"Kickoff Gust";default:return e}}function diceIdToName(e,a){if(5!=a)return e;switch(e){case 0:return"AD";case 1:return"BD";case 2:return"P";case 3:return"DS";case 4:return"DD";default:return e}}function twoDBDiceToName(e){switch(e){case 0:return"AD AD";case 1:return"AD BD";case 2:return"AD P";case 3:return"AD DS";case 4:return"AD DD";case 5:return"BD BD";case 6:return"BD P";case 7:return"BD DS";case 8:return"BD DD";case 9:return"P P";case 10:return"P DS";case 11:return"P DD";case 12:return"DS DS";case 13:return"DS DD";case 14:return"DD DD";default:return e}}function injuryDiceToName(e){switch(e){case 0:return"Stunned";case 1:return"KO'd";case 2:return"Casualty";default:return e}}function casualtyDiceToName(e){switch(e){case 0:return"No Long Term Effect";case 1:return"Miss Next Game";case 2:return"Niggling Injury";case 3:return"-1 MA";case 4:return"-1 AV";case 5:return"-1 AG";case 6:return"-1 ST";case 7:return"Dead";default:return e}}function diceToName(e,a){return 0==a?diceIdToName(e,5):-1==a?twoDBDiceToName(e):3==a?e+2:4==a?injuryDiceToName(e):5==a?casualtyDiceToName(e):e+1}function updateGameDetails(e){$("#file-name").text(e.fileName),$("#home-coach").text(e.homeTeam.coachName),$("#home-team").text(e.homeTeam.teamName),$("#home-race").text(raceIdToName(e.homeTeam.raceId)),$("#home-score").text(e.homeTeam.score),$("#away-coach").text(e.awayTeam.coachName),$("#away-team").text(e.awayTeam.teamName),$("#away-race").text(raceIdToName(e.awayTeam.raceId)),$("#away-score").text(e.awayTeam.score),$("#stadium-name").text(e.stadiumName)}function updateActions(e,a,t){$("#roll-details-table tbody").empty(),$.each(e,function(e,r){var n=$.map(r.dice,function(e){return diceIdToName(e,r.rollType)}),c=0==r.team?a.homeTeam.teamName:a.awayTeam.teamName,s=0==r.team?"home":"away",o=s;r.player in t&&(o=0==t[r.player].teamId?"home":"away"),$("#roll-details-table tbody").append('<tr><td class="'+s+'">'+r.turn+" ("+c+')</td><td class="'+o+'">'+(r.player in t?t[r.player].name:"N/A")+'</td><td class="'+o+'">'+rollTypeIdToName(r.rollType)+'</td><td class="'+o+'">'+n.join(" ")+"</td></tr>")})}function drawCharts(e,a){drawStatCharts("1DB","1dbs",e["1db"],a),delete e["1db"],drawStatCharts("2DB","2dbs",e["2db"],a),delete e["2db"],e[2]&&(drawStatCharts("Dodge","dodges",e[2],a),delete e[2]),drawStatCharts("Armour","armour",e.armour,a),delete e.armour,drawStatCharts("All Block Dice","allblocks",e.block,a),delete e.block,drawStatCharts("All Six-Sided (non-Block) Dice","sixsided",e.standard,a),delete e.standard,drawStatCharts("All Scatter Dice","scatter",e.scatter,a),delete e.scatter,drawStatCharts("Injury","injury",e.injury,a),delete e.injury,drawStatCharts("Casualty","cas",e.casualty,a),delete e.casualty,$.each(e,function(e,t){makeChartDiv(e),drawStatCharts(rollTypeIdToName(parseInt(e)),e,t,a)})}function roundedPercent(e){var a=100*e;return Math.round(100*a)/100}function adjustIndex(e,a){if(-1!=a)return e+1;switch(e){case 0:return 1;case 1:return 5;case 2:return 11;case 3:return 6;case 4:return 7;case 5:return 2;case 6:return 12;case 7:return 8;case 8:return 9;case 9:return 13;case 10:return 14;case 11:return 15;case 12:return 3;case 13:return 10;case 14:return 4;default:return e+1}}function drawStatCharts(e,a,t,r){var n="auto";switch(t.diceType){case 1:n=[1,2,3,4,5,6];break;case 2:n=[1,2,3,4,5,6,7,8];break;case 3:n=[2,3,4,5,6,7,8,9,10,11,12]}var c={title:e+" Percentages",seriesType:"bars",series:{2:{type:"line"}},legend:{position:"none"},hAxis:{ticks:n},focusTarget:"category",width:600,height:300},s={title:e+" Counts",seriesType:"bars",legend:{position:"none"},hAxis:{ticks:n},focusTarget:"category",width:600,height:300},o=[["Result",r.homeTeam.teamName,r.awayTeam.teamName,"Expected"]],u=[["Result",r.homeTeam.teamName,r.awayTeam.teamName]],i=0,d=0;$.each(t[0].histogram,function(e,a){if(!isNaN(a)){var r=t[1].histogram[e],n=diceToName(e,t.diceType),c=0==a?0:roundedPercent(parseFloat(a)/t[0].total),s=0==r?0:roundedPercent(parseFloat(r)/t[1].total),l=roundedPercent(t.expected[e]),m=adjustIndex(e,t.diceType);o[m]=[n,c,s,l],u[m]=[n,a,r],i+=a,d+=r}}),s.title+="\nTotals - "+r.homeTeam.teamName+": "+i+", "+r.awayTeam.teamName+": "+d;var l=google.visualization.arrayToDataTable(o),m=new google.visualization.ComboChart(document.getElementById(a+"-pct-chart"));m.draw(l,c);var h=google.visualization.arrayToDataTable(u),p=new google.visualization.ComboChart(document.getElementById(a+"-count-chart"));p.draw(h,s)}function makeChartDiv(e){var a=$("#other-stats-template").clone().show();a.find(".pct-chart").attr("id",e+"-pct-chart"),a.find(".count-chart").attr("id",e+"-count-chart"),a.appendTo($("#charts"))}google.load("visualization","1.0",{packages:["corechart"]}),google.setOnLoadCallback(enableFileInput);var fileInput=document.getElementById("file-input");fileInput.addEventListener("change",function(){fileInput.files.length>0&&($("#loading").show(),$("#data-param-error").hide(),$("#results-div").hide(),$("#share-alert").hide(),io.xmlToJson(fileInput.files[0],function(e){var a=replay.processReplay(e),t=JSONC.compress(a),r=JSON.stringify(t),n=LZString.compressToEncodedURIComponent(r);renderReplayData(a,n)},function(e){$("#loading").hide(),alert(e)}))});var dataParam=getParameterByName("data");dataParam&&($("#loading").show(),$("#data-param-error").hide(),google.setOnLoadCallback(renderDataParam));